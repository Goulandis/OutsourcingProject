<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>航班</title>
  <script src="assets/plus/threejs/three.min.js"></script>
  <script src="assets/plus/threejs/js/controls/OrbitControls.js"></script>
  <script src="assets/plus/threejs/js/libs/stats.min.js"></script>
  <script src="assets/plus/threejs/js/Detector.js"></script>
  <script src="assets/plus/threejs/socketio-1.4.5.js"></script>
  <script src="assets/plus/threejs/js/loaders/GLTFLoader.js"></script>


  <style>
    html{overflow: hidden;}
    body { margin: 0;}
  </style>


</head>

<body>
<!-- 存放canvas的容器 -->
<div id="zh_globe_container"></div> <!-- 容器 -->
<script>
  var log = console.log.bind(console);

  var globeObj = (function() {
    // 判断浏览器是否支持webgl
 //   if(!Detector.webgl) Detector.addGetWebGLMessage();

    var container, stats;
    var camera, scene, renderer;
    var group;
    var mouseX = 0, mouseY = 0;
    var winWth = window.innerWidth, winHgt = window.innerHeight;
    let lng,lat,alt;
    var ws;
    var object;
    // 获取position
    function getPosition(lng, lat, alt) {
      var phi = (90-lat)*(Math.PI/180),
              theta = (lng+180)*(Math.PI/180),
              radius = alt+200,
              x = -(radius * Math.sin(phi) * Math.cos(theta)),
              z = (radius * Math.sin(phi) * Math.sin(theta)),
              y = (radius * Math.cos(phi));
      return {x: x, y: y, z: z};
    }


      ws = null;
      //判断当前浏览器是否支持WebSocket
      if ('WebSocket' in window) {
        // ws = new WebSocket("ws://localhost:8080/myWs");
      }
      else {
        alert('当前浏览器 Not support websocket')
      }

      var WS_URL = "localhost:8080/myWs"
      // 如果页面是https,那么必须走wss协议, 否则走ws协议
      if (location.protocol == 'http:') {
        ws = new WebSocket("ws://"+WS_URL);

      } else {
        ws = new WebSocket("wss://"+WS_URL);
      }
      console.log(ws);
      //连接发生错误的回调方法
      ws.onerror = function () {
        setMessageInnerHTML("WebSocket连接发生错误");
      };

      //连接成功建立的回调方法
      ws.onopen = function(event) {
        console.log("ws调用连接成功回调方法");
        ws.onmessage();
        ws.send("")
      }
      //接收到消息的回调方法
      ws.onmessage = function(message) {
        console.log("onmessage 方法調用");
        console.log(ws.readyState)
        if (typeof (message.data )== "string") {
          //收到消息进行处理
          // setMessageInnerHTML(message.data);
          // 接受三维坐标消息
          // console.log(message.data);
          var Planedata = JSON.parse(message.data);
          object = scene.getObjectByName("planeMode");
          var Xlng = Planedata.latitude;
          var Ylat =Planedata.longitude;
          var Zalt =Planedata.geoAltitude;
          var resl = getPosition(Xlng,Ylat,5)
          // console.log(resl);
          // console.log(object);
          if(object){
            object.position.setX(resl.x);
            object.position.setY(resl.y );
            object.position.setZ(resl.z );
            console.log(object.position)
            // object.position.setZ(res.Z);
          }


        }

      }
      //ws连接断开的回调方法
      ws.onclose = function(e) {
        console.log("ws连接断开");
        console.log(e);
        setMessageInnerHTML("ws close");
      }

      //将消息显示在网页上
      function setMessageInnerHTML(innerHTML) {

          //收到消息进行处理
          // setMessageInnerHTML(message.data);
          // 接受三维坐标消息
          // console.log(message.data);
          var Planedata = JSON.parse(innerHTML.data);

          lng = Planedata.latitude;
          lat =Planedata.longitude;
          alt =Planedata.geoAltitude;
          // return lng,lat,alt;
      }

      //关闭连接
      function closeWebSocket() {
        ws.close();
      }


      //发送消息
      function send(msg) {
        if(!msg){
          msg = document.getElementById('text').value;
          // document.getElementById('message').innerHTML += "发送的消息:" + msg + '<br/>';
          ws.send(msg);
        }
      }


    function plane() {


      //加载模型，并在回调中将生成的模型对象添加到场景中
      let loader = new THREE.GLTFLoader();

      let panleMode = loader.load("./assets/plus/threejs/basic_plane/scene.gltf", function (gltf) {
        gltf.scene.traverse(function (child) {
          child.name = "planeMode";
        })
        gltf.scene.scale.set(5,5,5);
        // gltf.scene.position.setX(150);
        // gltf.scene.position.setY(150);
        console.log( gltf);
        // group.add(gltf);
        group.add(gltf.scene);
        // lng,lat,alt;
      });
    }
    // 飞机
    function plane1() {
      // 飞机标记
      var planeMarkers = {};
      // 飞机形状
      var planeShape = new THREE.Shape();
      planeShape.moveTo( 50, 25);
      planeShape.lineTo(0.2, -0.2);
      planeShape.lineTo(0.2, -1.3);
      planeShape.lineTo(1.6,-2.7);
      planeShape.lineTo(1.6,-3);
      planeShape.lineTo(0.2, -2.1);
      planeShape.lineTo(0.2, -3);
      planeShape.lineTo(0.5, -3.4);
      planeShape.lineTo(0.5, -3.7);
      planeShape.lineTo(0, -3.3);
      planeShape.lineTo(-0.5, -3.7);
      planeShape.lineTo(-0.5, -3.4);
      planeShape.lineTo(-0.2, -3);
      planeShape.lineTo(-0.2, -2.1);
      planeShape.lineTo(-1.6,-3);
      planeShape.lineTo(-1.6,-2.7);
      planeShape.lineTo(-0.2, -1.3);
      planeShape.lineTo(-0.2, -0.2);
      var planeGeometry = new THREE.ShapeGeometry(planeShape);
      // 飞机材质
      var planeMaterial = new THREE.MeshPhongMaterial({color: 0x0FB4DD, side: THREE.DoubleSide, depthTest: false});
      // 添加飞机
      var plane = new THREE.Mesh(planeGeometry, planeMaterial);
      // 旋转 lng,lat,alt
      // plane.rotation.z = THREE.Math.degToRad(alt);
      // 定位
      var position = getPosition(lng, lat, alt);
      plane.position.set(position.x/2000, position.y/1000, position.z/1000);
      console.log(position.x/1000);
      plane.visible = true;
      // 显示/隐藏
      // plane.visible = false;
      // 保存
      // 添加到场景
      group.add(plane);


      // 点动画
      var pointGeometry = new THREE.SphereGeometry(0.2, 20, 20);
      var pointMaterial = new THREE.MeshBasicMaterial({color: 0x40E0D0});
      function addLightPoint(pos, coordsNum ,verArr) {
        var pointMesh = new THREE.Mesh(pointGeometry, pointMaterial);
        pointMesh.position.set(pos.x, pos.y, pos.z);
        group.add(pointMesh);

        var index = 0;
        function pointAnimate() {
          index++;
          if(index>coordsNum) {
            index = 0;
          }
          pointMesh.position.set(verArr[index].x, verArr[index].y, verArr[index].z);
          requestAnimationFrame(pointAnimate);
        }
        pointAnimate();


      }


    }


    function globe() {
      var globeTextureLoader = new THREE.TextureLoader();
      globeTextureLoader.load('assets/plus/threejs/img/earth.jpg', function (texture) {
        var globeGgeometry = new THREE.SphereGeometry(200, 100, 100);
        var globeMaterial = new THREE.MeshStandardMaterial({map: texture});
        var globeMesh = new THREE.Mesh(globeGgeometry, globeMaterial);
        group.add(globeMesh);
        // group.rotation.x = THREE.Math.degToRad(35);
        // group.rotation.y = THREE.Math.degToRad(170);
      });
    }

    // 星点
    function stars() {
      var starsGeometry = new THREE.Geometry();
      for (var i = 0; i < 2000; i ++) {
        var starVector = new THREE.Vector3(
                THREE.Math.randFloatSpread(2000),
                THREE.Math.randFloatSpread(2000),
                THREE.Math.randFloatSpread(2000)
        );
        starsGeometry.vertices.push(starVector);
      }
      var starsMaterial = new THREE.PointsMaterial({color: 0x888888})
      var starsPoint = new THREE.Points(starsGeometry, starsMaterial);
      group.add(starsPoint);
    }

    // 光
    function lights() {
      var hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x333333, 2);
      hemisphereLight.position.x = 0;
      hemisphereLight.position.y = 0;
      hemisphereLight.position.z = -200;
      group.add(hemisphereLight);
    }

    // 初始化
    function init() {
      container = document.getElementById('zh_globe_container');

      scene = new THREE.Scene();
      var bgTexture = new THREE.TextureLoader().load("assets/plus/threejs/img/starfield.jpg");
      // scene.background = bgTexture;

      camera = new THREE.PerspectiveCamera(50, winWth/winHgt, 1, 2000);
      camera.up.x = 0;
      camera.up.y = 1;
      camera.up.z = 0;
      camera.position.x = 0;
      camera.position.y = 0;
      camera.position.z = 600;
      camera.lookAt(0,0,0);

      group = new THREE.Group();
      scene.add(group);

      // 地球
      globe();

      // 飞机
      plane();
      //
      // 星点
      stars();

      // 半球光
      lights();

      // 渲染器
      renderer = new THREE.WebGLRenderer({antialias: true, preserveDrawingBuffer: true});
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(winWth, winHgt);
      container.appendChild(renderer.domElement);

      // 盘旋控制
      var orbitControl = new THREE.OrbitControls(camera, renderer.domElement);
      orbitControl.minDistrance = 20;
      orbitControl.maxDistrance = 50;
      orbitControl.maxPolarAngle = Math.PI/2;

      // 性能测试
      stats = new Stats();
      container.appendChild(stats.dom);

      // resize事件
      window.addEventListener('resize', onWindowResize, false);
    }

    // 窗口大小改变
    function onWindowResize() {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // 渲染
    function render() {
      // group.rotation.y -= 0.0005;
      renderer.render(scene, camera);
    }

    // 动画
    function animate() {
      requestAnimationFrame(animate);
      render();
      stats.update();
    }

    init();
    animate();
  })();
</script>
</body>

</html>